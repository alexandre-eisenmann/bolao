<!DOCTYPE html>
<html>
<head>
<script src="d3.v3.min.js" charset="utf-8"></script>
<script src="jquery-2.1.1.min.js" charset="utf-8"></script>
<script src="data.js" charset="utf-8"></script>

<style>


body {
  background-color: black;
}
svg {

  height: 10000px;
  width: 3000px;

}

.botoes {


}
.botao {
  float:left;
  color: #444;
  font-family: sans-serif;
  font-size: 12px;
  border: 2px solid #444;
  width: 180px;
  padding: 10px;
  margin-top: 10px;
  margin-left: 10px;
}

.clickable {
  color: #888;
  border-color: #888;
}

.clickable:hover {
  color: white;
  border-color: white;
  cursor: pointer;
}


.header {
  height:50px;
  width:5000px;
}

.marked {
  background-color: yellow;

}
.game {
  float:left;
  width: 28px;
  color: white;
  padding-top: 3px;
  padding-bottom: 3px;
}

.select-game {
  border: 2px solid red;

}

.left:hover,.right:hover {
  color: blue;
}

.left-gols,.right-gols {
  font-family: sans-serif;
  font-size:10px;
  text-align:center;
  height: 10px;
}

.left,.right {
/*  border: 1px solid black;*/
  font-family: sans-serif;
  font-size:10px;
  cursor: pointer;
  text-align:center;

}

</style>
</head>
<body>

  <div class="header">
    <div class="game">
      <div class="left">BRA</div>
      <div class="right">CRO</div>
      <div class="left-gols">3</div>
      <div class="right-gols">1</div>
    </div>
    <div class="game">
      <div class="left">MEX</div>
      <div class="right">CAM</div>
      <div class="left-gols">1</div>
      <div class="right-gols">0</div>
    </div>
    <div class="game">
      <div class="left">ESP</div>
      <div class="right">HOL</div>
      <div class="left-gols">1</div>
      <div class="right-gols">5</div>
    </div>
    <div class="game">
      <div class="left">CHI</div>
      <div class="right">AUS</div>
      <div class="left-gols">3</div>
      <div class="right-gols">1</div>
    </div>
    <div class="game">
      <div class="left">COL</div>
      <div class="right">GRE</div>
      <div class="left-gols">3</div>
      <div class="right-gols">0</div>
    </div>
    <div class="game">
      <div class="left">URU</div>
      <div class="right">COS</div>
      <div class="left-gols">1</div>
      <div class="right-gols">3</div>
    </div>
    <div class="game">
      <div class="left">ING</div>
      <div class="right">ITA</div>
      <div class="left-gols">1</div>
      <div class="right-gols">2</div>
    </div>
    <div class="game">
      <div class="left">CDM</div>
      <div class="right">JAP</div>
      <div class="left-gols">2</div>
      <div class="right-gols">1</div>
    </div>
    <div class="game">
      <div class="left">SUI</div>
      <div class="right">EQU</div>
      <div class="left-gols">2</div>
      <div class="right-gols">1</div>
    </div>
    <div class="game">
      <div class="left">FRA</div>
      <div class="right">HON</div>
      <div class="left-gols">3</div>
      <div class="right-gols">0</div>
    </div>
    <div class="game">
      <div class="left">ARG</div>
      <div class="right">BOS</div>
      <div class="left-gols">2</div>
      <div class="right-gols">1</div>
    </div>
    <div class="game">
      <div class="left">ALE</div>
      <div class="right">POR</div>
      <div class="left-gols">4</div>
      <div class="right-gols">0</div>
    </div>
    <div class="game">
      <div class="left">IRA</div>
      <div class="right">NIG</div>
      <div class="left-gols">0</div>
      <div class="right-gols">0</div>
    </div>
    <div class="game">
      <div class="left">GAN</div>
      <div class="right">EUA</div>
      <div class="left-gols">1</div>
      <div class="right-gols">2</div>
    </div>
    <div class="game">
      <div class="left">BEL</div>
      <div class="right">AGL</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">BRA</div>
      <div class="right">MEX</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">RUS</div>
      <div class="right">COR</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">AUS</div>
      <div class="right">HOL</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">ESP</div>
      <div class="right">CHI</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">CRO</div>
      <div class="right">CAM</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">COL</div>
      <div class="right">CDM</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">URU</div>
      <div class="right">ING</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">JAP</div>
      <div class="right">GRE</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">ITA</div>
      <div class="right">COS</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">SUI</div>
      <div class="right">FRA</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">HON</div>
      <div class="right">EQU</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">ARG</div>
      <div class="right">IRA</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">ALE</div>
      <div class="right">GAN</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">NIG</div>
      <div class="right">BOS</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">BEL</div>
      <div class="right">RUS</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">COR</div>
      <div class="right">AGL</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">EUA</div>
      <div class="right">POR</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">AUS</div>
      <div class="right">ESP</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">HOL</div>
      <div class="right">CHI</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">CAM</div>
      <div class="right">BRA</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">CRO</div>
      <div class="right">MEX</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">COS</div>
      <div class="right">ING</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">ITA</div>
      <div class="right">URU</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">GRE</div>
      <div class="right">CDM</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">JAP</div>
      <div class="right">COL</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">BOS</div>
      <div class="right">IRA</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">NIG</div>
      <div class="right">ARG</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">EQU</div>
      <div class="right">FRA</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">HON</div>
      <div class="right">SUI</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">POR</div>
      <div class="right">GAN</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">EUA</div>
      <div class="right">ALE</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">AGL</div>
      <div class="right">RUS</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
    <div class="game">
      <div class="left">COR</div>
      <div class="right">BEL</div>
      <div class="left-gols"></div>
      <div class="right-gols"></div>
    </div>
  </div>
  <div class="botoes" >
    <div id="stepfast" class="botao clickable">ESTOU COM PRESSA</div>
    <div id="step" class="botao clickable">CALCULAR PROXIMO JOGO</div>
  </div>
  <div id="jogos"></div>
  <div id="resultados"></div>

<script type="text/javascript">

  var left = function(d) { return d.left }
  var right = function(d) { return d.right }
  var pontos = function(palpite, efetivo) {
    if (palpite.left == efetivo.left && palpite.right == efetivo.right) {
      return 8;
    } else if (palpite.left - palpite.right == efetivo.left - efetivo.right) {
      return 5;
    } else if (palpite.left > palpite.right && efetivo.left > efetivo.right) {
      return 3;
    } else if (palpite.left < palpite.right && efetivo.left < efetivo.right) {
      return 3;
    } else {
      return 0;
    }
  }

  var height = 18;
  var xAdvance = 0;
  var widthMultiplier = 10;

  var dataset = [];
  var svg = d3.select("#jogos").append("svg:svg")

  function reset() {
    dataset = [];
    tabelao.sort(function(a,b) {return a[3].localeCompare(b[3])})
    for(var i in tabelao) {
      tabelao[i][0] = 0;
    }
  }

  reset();

  function addPlayers(svg) {

    svg.selectAll("g")
    .data(tabelao)
    .enter()
    .append("g")
    .attr("transform",function(d,i) {
      return "translate(0," + ((i+1)*(height+1)-3) + ")"
    })
    .each(function(d,i) {
      var playerName = d[3].toUpperCase();
      var playerGroup = d3.select(this);

      playerGroup.attr("class","c" + d[1]);

      playerGroup
      .append("text")
      .text(playerName)
      .attr("x",10)
      .attr("y",height-5)
      .attr("font-family","sans-serif")
      .attr("font-size","10px")
      .attr("fill","#777")

    })

  }

  addPlayers(svg);

  var rainDuration = 1000;
  var sortDuration = 500;
  var goLeftDuration = 50;
  var assyncDurationDown = 30;
  var assyncDurationUp = 10;
  var topViewport = 50;
  var bottom = $(window).height()*4/5;
  var mode = 'pressa';


  function adjustViewport(y) {
     if (mode=='pressa') return;
     if (y > bottom) {
        var diff = y - bottom;
        topViewport += diff;
        bottom += diff;
        $(window).scrollTop(topViewport);
     } else if (y < topViewport) {
        var diff = topViewport - y;
        if (topViewport - diff >0) {
          topViewport -= diff;
          bottom -= diff;
        } else {
          top -= topViewport;
          bottom -= topViewport;
        }
        $(window).scrollTop(topViewport);
     }
  }

  var closure = function(x) {
     return function() {
       adjustViewport(x);
     }
  }


  function buildUpdate(jIndex) {
    return function(n,m, callback) {

    var j = { "left": n, "right": m};

    dataset.push(j);

    var resultados = d3.select("#resultados")
    var delay = 0;


    resultados.selectAll("div")
      .data(dataset)
      .enter()
      .append("div")
      .each(function(d,i) {
        var that = this;

        for (var index in tabelao) {
           var pts = pontos({left: tabelao[index][jIndex], right:tabelao[index][jIndex+1]},d);
           var playerName = tabelao[index][3];
           var  barWidth = (1 + pts)*widthMultiplier;

          //  if (pts>0) {
              var y = ((parseInt(index)+1)*(height+1)-3);

              var bar = d3.select('.c' + tabelao[index][1])
              .append("rect")
              .attr("x",$(window).width())
              .attr("y",0)
              .attr("width",barWidth)
              .attr("height",height)
              .attr("fill",{0:"#555",3:"#33ccff",5:"green",8:"yellow"}[pts])
              .attr("opacity",0.4);

              bar
              .transition()
              .delay(delay)
              .duration(rainDuration)
              .attr("x",xAdvance + tabelao[index][0])
              .each("start", closure(y));

              delay+= assyncDurationDown;
              tabelao[index][0] += barWidth;
          //  }
        }
        delay+=rainDuration;
        tabelao.sort(function(a,b) {return b[0] - a[0] + a[3].localeCompare(b[3])})
        for (var index in tabelao) {
           var y = ((parseInt(index)+1)*(height+1)-3);
           var bar = d3.select('.c' + tabelao[index][1])

           bar
              .transition()
              .delay(delay)
              .duration(sortDuration)
              .attr("transform","translate(212," + y + ")")
              .each("start", closure(y));

          delay+= assyncDurationDown;
       }
       delay+=sortDuration;
       for (var j in tabelao) {
           var index = tabelao.length - parseInt(j) -1;
           var y = ((index+1)*(height+1)-3);
           var bar = d3.select('.c' + tabelao[index][1])

           bar
              .transition()
              .delay(delay)
              .duration(goLeftDuration)
              .attr("transform","translate(0," + y + ")")
              .each("start", closure(y));

          delay+= assyncDurationUp;
       }
       delay+=goLeftDuration;
       jIndex += 3;
      });

      setTimeout(function() {
        callback();
      },delay);

    }
  }


var marked;


$( document ).ready(function() {

   $('body').bind('keypress', function(e) {

     if (!marked) return;

      var className=".left-gols";
      if (marked.hasClass("right")) {
        className=".right-gols";
      }

     var gols = Number(marked.parent().find(className).html());


     var code = e.keyCode || e.which;
     if (code == 43) {
       gols++;
       marked.parent().find(className).html(gols)
     } else if (code == 95) {
       if (gols>0) gols--;
       marked.parent().find(className).html(gols)
     }
   });



    $(".left, .right").click(function() {

       if (marked) {
         marked.toggleClass("marked");
       }
       marked = $(this);
       marked.toggleClass("marked");

    })

    var update = buildUpdate(5);
    reset();
    addPlayers(svg);

    var process = function() {

        var botao  = $(this).attr("id");
        if (!$(this).hasClass("clickable"))
          return;


        if (botao == "stepfast") {
          mode = 'pressa';
          rainDuration = 0;
          sortDuration = 0;
          goLeftDuration = 0;
          assyncDurationDown = 0;
          assyncDurationUp = 0;

        } else {
          mode = 'animacao';
          rainDuration = 1000;
          sortDuration = 500;
          goLeftDuration = 50;
          assyncDurationDown = 30;
          assyncDurationUp = 10;
        }

       var selectGame = $(".select-game").first();
       var game;
       if (selectGame.length > 0 ) {
         game = selectGame.next()
       } else {
         game = $(".game").first()
       }

       var leftGols = game.find('.left-gols').html();
       var rightGols = game.find('.right-gols').html();

       if (leftGols && rightGols) {
         $(this).toggleClass("clickable");

         if (selectGame.length > 0 ) selectGame.toggleClass("select-game")
         game.toggleClass("select-game");

         update(leftGols, rightGols, function() {
            $("#"+ botao).toggleClass("clickable");
            $(window).scrollTop(0);
         });
      }
    }

    $(".clickable").click(process);


});

</script>
</body>
</html>
